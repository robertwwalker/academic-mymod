<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.59.0" />
  <meta name="author" content="Robert W. Walker">

  
  
  
  
    
      
    
  
  <meta name="description" content="Alluvial and Sankey Diagrams The aforementioned plots are methods for visualising the flow of data through a stream of markers. I was motivated to show this because enough of you deal in orders, tickets, and the like the flow visualisation of a system might prove of use. I will work with a familiar dataset. These are data on Admissions at the University of California Berkeley. The data exist as an internal R file in tabular form.">

  
  <link rel="alternate" hreflang="en-us" href="/r/alluvials/">

  



  
  
  <meta name="theme-color" content="">
  
  
  
  
    
  
  
    
    
      
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js//styles/dracula.min.css">
      
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/%!s(<nil>)/css/bootstrap.min.css" integrity="%!s(<nil>)" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/%!s(<nil>)/css/academicons.min.css" integrity="%!s(<nil>)" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/%!s(<nil>)/css/font-awesome.min.css" integrity="%!s(<nil>)" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/%!s(<nil>)/jquery.fancybox.min.css" integrity="%!s(<nil>)" crossorigin="anonymous">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/%!s(<nil>)/leaflet.css" integrity="%!s(<nil>)" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="/styles.css">
  

  

  
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Robert W. Walker">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Robert W. Walker">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/r/alluvials/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@PieRatio">
  <meta property="twitter:creator" content="@PieRatio">
  
  <meta property="og:site_name" content="Robert W. Walker">
  <meta property="og:url" content="/r/alluvials/">
  <meta property="og:title" content="Alluvial Plots | Robert W. Walker">
  <meta property="og:description" content="Alluvial and Sankey Diagrams The aforementioned plots are methods for visualising the flow of data through a stream of markers. I was motivated to show this because enough of you deal in orders, tickets, and the like the flow visualisation of a system might prove of use. I will work with a familiar dataset. These are data on Admissions at the University of California Berkeley. The data exist as an internal R file in tabular form.">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-10-09T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2019-10-09T00:00:00&#43;00:00">
  

  

  <title>Alluvial Plots | Robert W. Walker</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" class="dark">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/"><img src="/img/headers/wuagsm.jpg" alt="Robert W. Walker"></a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#publications_selected">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/img/vita.pdf">
            
            <span>Curriculum Vitae</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
            
          </a>
        </li>

        
        

        
        
        
        
        

        <li class="nav-item">
          <a href="/r">
            
            <span>R Stuff</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#teaching">
            
            <span>Teaching</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <h1 itemprop="name">Alluvial Plots</h1>

    

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2019-10-09 00:00:00 &#43;0000 UTC" itemprop="datePublished dateModified">
      2019-10-09
    </time>
  </span>
  <span itemscope itemprop="author publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Robert W. Walker">
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    8 min read
  </span>
  

  
  

  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Alluvial%20Plots&amp;url=%2fr%2falluvials%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fr%2falluvials%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fr%2falluvials%2f&amp;title=Alluvial%20Plots"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fr%2falluvials%2f&amp;title=Alluvial%20Plots"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Alluvial%20Plots&amp;body=%2fr%2falluvials%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


    <div class="article-style" itemprop="articleBody">
      


<div id="alluvial-and-sankey-diagrams" class="section level2">
<h2>Alluvial and Sankey Diagrams</h2>
<p>The aforementioned plots are methods for visualising the flow of data through a stream of markers. I was motivated to show this because enough of you deal in orders, tickets, and the like the flow visualisation of a system might prove of use. I will work with a familiar dataset. These are data on Admissions at the University of California Berkeley. The data exist as an internal R file in tabular form.</p>
<pre class="r"><code>library(tidyverse)
library(ggalluvial) # if this is not installed, install.packages(&quot;ggalluvial&quot;)
data(&quot;UCBAdmissions&quot;) # This dataset is built in as a set of tables.
UCBAdmissions  # What does it look like?</code></pre>
<pre><code>## , , Dept = A
## 
##           Gender
## Admit      Male Female
##   Admitted  512     89
##   Rejected  313     19
## 
## , , Dept = B
## 
##           Gender
## Admit      Male Female
##   Admitted  353     17
##   Rejected  207      8
## 
## , , Dept = C
## 
##           Gender
## Admit      Male Female
##   Admitted  120    202
##   Rejected  205    391
## 
## , , Dept = D
## 
##           Gender
## Admit      Male Female
##   Admitted  138    131
##   Rejected  279    244
## 
## , , Dept = E
## 
##           Gender
## Admit      Male Female
##   Admitted   53     94
##   Rejected  138    299
## 
## , , Dept = F
## 
##           Gender
## Admit      Male Female
##   Admitted   22     24
##   Rejected  351    317</code></pre>
<pre class="r"><code>UCBADF &lt;- data.frame(UCBAdmissions)  # For it into a data.frame
UCBADF  # This is what the data structure needs to look like.</code></pre>
<pre><code>##       Admit Gender Dept Freq
## 1  Admitted   Male    A  512
## 2  Rejected   Male    A  313
## 3  Admitted Female    A   89
## 4  Rejected Female    A   19
## 5  Admitted   Male    B  353
## 6  Rejected   Male    B  207
## 7  Admitted Female    B   17
## 8  Rejected Female    B    8
## 9  Admitted   Male    C  120
## 10 Rejected   Male    C  205
## 11 Admitted Female    C  202
## 12 Rejected Female    C  391
## 13 Admitted   Male    D  138
## 14 Rejected   Male    D  279
## 15 Admitted Female    D  131
## 16 Rejected Female    D  244
## 17 Admitted   Male    E   53
## 18 Rejected   Male    E  138
## 19 Admitted Female    E   94
## 20 Rejected Female    E  299
## 21 Admitted   Male    F   22
## 22 Rejected   Male    F  351
## 23 Admitted Female    F   24
## 24 Rejected Female    F  317</code></pre>
</div>
<div id="an-alluvial" class="section level2">
<h2>An Alluvial</h2>
<p>This is the tidy version that we worked with at the individual level. To make this code work, change the below locations to import the same data.</p>
<pre class="r"><code>load(url(&quot;https://github.com/robertwwalker/academic-mymod/raw/master/data/UCBtidy.RData&quot;))
head(DiscriminationUCB)</code></pre>
<pre><code>##    M.F Admit Dept
## 1 Male   Yes    A
## 2 Male   Yes    A
## 3 Male   Yes    A
## 4 Male   Yes    A
## 5 Male   Yes    A
## 6 Male   Yes    A</code></pre>
<p>To put this data in a table, using the <code>%&gt;%</code> pipe operator, we will pass the tidy data, group it by the elements of the alluvial, and then generate the counts.</p>
<pre class="r"><code>DUCBT &lt;- DiscriminationUCB %&gt;% group_by(M.F,Dept,Admit) %&gt;% summarise(count = n()) %&gt;% ungroup()
DUCBT</code></pre>
<pre><code>## # A tibble: 24 x 4
##    M.F    Dept  Admit count
##    &lt;fct&gt;  &lt;fct&gt; &lt;fct&gt; &lt;int&gt;
##  1 Female A     No       19
##  2 Female A     Yes      89
##  3 Female B     No        8
##  4 Female B     Yes      17
##  5 Female C     No      391
##  6 Female C     Yes     202
##  7 Female D     No      244
##  8 Female D     Yes     131
##  9 Female E     No      299
## 10 Female E     Yes      94
## # … with 14 more rows</code></pre>
<p>The alluvial requires an additional package <code>ggalluvial</code>. We can install it through <code>install.packages(&quot;ggalluvial&quot;)</code>. What can it do? It needs data. The y axis is always the total counts in the cells. Then we set axes with a number after to show the phases from left to right. So here, axis1 will be gender and axis two will be Department. Admitted and non-admitted students will be <code>flowed</code> with colors depicting them move through the system. We want to track them by their admitted status. The alluvial itself has y as Frequency and the various axis* as the phases to track. The outcome of interest enters the fill so that color shows the outcome of interest flowing through the strata.</p>
</div>
<div id="with-the-system-data" class="section level2">
<h2>With the system data</h2>
<p>This is the vignette solution to these data with the package. Extending it to any data is a two step process.</p>
<pre class="r"><code>ggplot(UCBADF,
       aes(y = Freq, axis1 = Gender, axis2 = Dept)) +
  geom_alluvium(aes(fill = Admit), width = 1/12) +
  geom_stratum(width = 1/12, fill = &quot;black&quot;, color = &quot;grey&quot;) +
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE) +
  scale_x_discrete(limits = c(&quot;Gender&quot;, &quot;Dept&quot;), expand = c(.05, .05)) + # Fix the x axis
  scale_fill_brewer(type = &quot;qual&quot;, palette = &quot;Set1&quot;) + # Give it nice colors
  ggtitle(&quot;UC Berkeley admissions and rejections, by sex and department&quot;) # give it a title</code></pre>
<p><img src="/R/Alluvials_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="a-simple-one-or-as-simple-as-i-can" class="section level1">
<h1>A simple one [or as simple as I can]</h1>
<p>A lot of the code is just prettying. The most basic plot needs this:</p>
<pre class="r"><code>ggplot(UCBADF,  # plot the data
       aes(y = Freq, axis1 = Gender, axis2 = Dept)) + # what are the named axes
  geom_alluvium(aes(fill = Admit), width = 1/12) + # what variable will fill the paths; Admission here.
  geom_stratum(width = 1/12, fill = &quot;black&quot;, color = &quot;grey&quot;) + # This set the strata that our people will move through The one 12 is 12 combinations; the two colors here dfine the background and text for the labels.
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE)  # This labels them.</code></pre>
<p><img src="/R/Alluvials_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Same with our data.</p>
<pre class="r"><code>ggplot(DUCBT,
       aes(y = count, axis1 = M.F, axis2 = Dept)) +
  geom_alluvium(aes(fill = Admit), width = 1/12) +
  geom_stratum(width = 1/12, fill = &quot;black&quot;, color = &quot;grey&quot;) +
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE) </code></pre>
<p><img src="/R/Alluvials_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<div id="the-titanic-multiple-phases" class="section level2">
<h2>The Titanic: Multiple Phases</h2>
<pre class="r"><code>data(&quot;Titanic&quot;)
Titanic</code></pre>
<pre><code>## , , Age = Child, Survived = No
## 
##       Sex
## Class  Male Female
##   1st     0      0
##   2nd     0      0
##   3rd    35     17
##   Crew    0      0
## 
## , , Age = Adult, Survived = No
## 
##       Sex
## Class  Male Female
##   1st   118      4
##   2nd   154     13
##   3rd   387     89
##   Crew  670      3
## 
## , , Age = Child, Survived = Yes
## 
##       Sex
## Class  Male Female
##   1st     5      1
##   2nd    11     13
##   3rd    13     14
##   Crew    0      0
## 
## , , Age = Adult, Survived = Yes
## 
##       Sex
## Class  Male Female
##   1st    57    140
##   2nd    14     80
##   3rd    75     76
##   Crew  192     20</code></pre>
<pre class="r"><code>TDF &lt;- as.data.frame(Titanic)
TDF</code></pre>
<pre><code>##    Class    Sex   Age Survived Freq
## 1    1st   Male Child       No    0
## 2    2nd   Male Child       No    0
## 3    3rd   Male Child       No   35
## 4   Crew   Male Child       No    0
## 5    1st Female Child       No    0
## 6    2nd Female Child       No    0
## 7    3rd Female Child       No   17
## 8   Crew Female Child       No    0
## 9    1st   Male Adult       No  118
## 10   2nd   Male Adult       No  154
## 11   3rd   Male Adult       No  387
## 12  Crew   Male Adult       No  670
## 13   1st Female Adult       No    4
## 14   2nd Female Adult       No   13
## 15   3rd Female Adult       No   89
## 16  Crew Female Adult       No    3
## 17   1st   Male Child      Yes    5
## 18   2nd   Male Child      Yes   11
## 19   3rd   Male Child      Yes   13
## 20  Crew   Male Child      Yes    0
## 21   1st Female Child      Yes    1
## 22   2nd Female Child      Yes   13
## 23   3rd Female Child      Yes   14
## 24  Crew Female Child      Yes    0
## 25   1st   Male Adult      Yes   57
## 26   2nd   Male Adult      Yes   14
## 27   3rd   Male Adult      Yes   75
## 28  Crew   Male Adult      Yes  192
## 29   1st Female Adult      Yes  140
## 30   2nd Female Adult      Yes   80
## 31   3rd Female Adult      Yes   76
## 32  Crew Female Adult      Yes   20</code></pre>
<pre class="r"><code>ggplot(TDF,
       aes(y = Freq, axis1 = Class, axis2 = Age, axis3 = Sex, axis4=Survived)) +
  geom_alluvium(aes(fill = Survived), width = 1/24) +
  geom_stratum(width = 1/12, fill = &quot;white&quot;, color = &quot;black&quot;) +
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE) +
  scale_x_discrete(limits = c(&quot;Class&quot;, &quot;Age&quot;, &quot;Sex&quot;)) + # Fix the x axis
  scale_fill_brewer(type = &quot;qual&quot;, palette = &quot;Set1&quot;) + # Give it nice colors
  ggtitle(&quot;The Fate of Titanic Passengers&quot;, subtitle=&quot;Class, Sex, Age&quot;) # give it a title </code></pre>
<p><img src="/R/Alluvials_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Now for one better, we can combine variables. I will use the titanic data and combine Age and Sex into a new variable people. THey will now flow through Class to Survival starting with four types of people. I recently discovered Beyonce palettes; I will use Beyonce 56 for this alluvial.</p>
<pre class="r"><code>library(beyonce)
TDF2 &lt;- TDF %&gt;% mutate(People = Sex:Age)
TDF2 %&gt;% group_by(People,Class,Survived) %&gt;% ungroup()</code></pre>
<pre><code>## # A tibble: 32 x 6
##    Class Sex    Age   Survived  Freq People      
##    &lt;fct&gt; &lt;fct&gt;  &lt;fct&gt; &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;       
##  1 1st   Male   Child No           0 Male:Child  
##  2 2nd   Male   Child No           0 Male:Child  
##  3 3rd   Male   Child No          35 Male:Child  
##  4 Crew  Male   Child No           0 Male:Child  
##  5 1st   Female Child No           0 Female:Child
##  6 2nd   Female Child No           0 Female:Child
##  7 3rd   Female Child No          17 Female:Child
##  8 Crew  Female Child No           0 Female:Child
##  9 1st   Male   Adult No         118 Male:Adult  
## 10 2nd   Male   Adult No         154 Male:Adult  
## # … with 22 more rows</code></pre>
<pre class="r"><code>ggplot(TDF2,
       aes(y = Freq, axis1 = People, axis2 = Class, axis3=Survived)) +
  geom_alluvium(aes(fill = Survived), width = 1/24) +
  geom_stratum(width = 1/12, fill = &quot;white&quot;, color = &quot;black&quot;) +
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE) +
  scale_x_discrete(limits = c(&quot;People&quot;, &quot;Class&quot;, &quot;Survived&quot;)) + # Fix the x axis
  scale_fill_manual(values = beyonce_palette(56)) + # Give it nice colors
  ggtitle(&quot;The Fate of Titanic Passengers&quot;, subtitle=&quot;Class, People&quot;) # give it a title </code></pre>
<p><img src="/R/Alluvials_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>

    </div>

    


    
    

    

    


  </div>
</article>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2018 &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/%!s(<nil>)/jquery.min.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/%!s(<nil>)/imagesloaded.pkgd.min.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/%!s(<nil>)/js/bootstrap.min.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/%!s(<nil>)/isotope.pkgd.min.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/%!s(<nil>)/jquery.fancybox.min.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/%!s(<nil>)/leaflet.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/%!s(<nil>)/highlight.min.js" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
      

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/%!s(<nil>)/MathJax.js?config=TeX-AMS_CHTML" integrity="%!s(<nil>)" crossorigin="anonymous"></script>
    
    

  </body>
</html>

