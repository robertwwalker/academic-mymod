---
title: nflscrapR is amazing
author: RWW
date: '2019-04-30'
slug: nflscrapr-is-amazing
categories:
  - R
  - tidyverse
  - animation
tags:
  - plot
  - R
  - R Markdown
  - tidyverse
header:
  caption: ''
  image: ''
  preview: yes
---

## Scraping NFL data

The `nflscrapR` package is designed to make data on NFL games more easily available.  To install the package, we need to grab it from github.

```{r cars, eval=FALSE, echo=TRUE}
devtools::install_github(repo = "maksimhorowitz/nflscrapR")
```

The github page for [nflscrapR](https://github.com/maksimhorowitz/nflscrapR) is quite informative.

## Getting Some Data

Following the guide to the package on GitHub, let me try their example.  It works, but I will save off the data to github to avoid spamming the host.

```{r NFLdata, eval=FALSE, message=FALSE, warning=FALSE}
library(nflscrapR)
all_2018_games <- scrape_game_ids(2018) # Default is regular season
```

Gives me a list of all games.  I saved them to an .rds file and stored them on Gitub.  To make it browsable, I will use `kable` and the like.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(nflscrapR)
library(RCurl)
library(kableExtra)
library(gganimate)
library(ggrepel)
all_2018_games <-readRDS(url("https://github.com/robertwwalker/academic-mymod/raw/master/data/NFLGames2018.rds"))
all_2018_games %>%  kable()  %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "300px")
```

That's all the regular season games in the 2018 season.  They suggest that it is straightforward to grab an entire season of play by play data.

```{r, echo=TRUE, eval=FALSE}
full_season_2018 <- scrape_season_play_by_play(2018, "reg")
saveRDS(full_season_2018, file="../../../data/2018NFLSeason.rds")
```

That gets the data though it took over an hour to acquire it all and it threw two error messages.  I do not yet know if they are conseequential.  My goal here is to use this package and the ability to plot the win probability charts to try to summarise an entire cowboys season.

```{r}
full_season_2018 <- readRDS(url("https://github.com/robertwwalker/academic-mymod/raw/master/data/2018NFLSeason.rds")) 
```

## What can I do with it?

When I paid attention the NFL, I followed the Dallas Cowboys.  Let's isolate their data.

```{r}
dal_season <- full_season_2018 %>% filter(home_team=="DAL" | away_team=="DAL")
dal_season %>%  head()
#  kable()  %>%
#  kable_styling() %>%
#  scroll_box(width = "100%", height = "200px")
```

## Dallas Season

Now I want to try and build a plot of all of Dallas Cowboys games for the season.  Here are the steps.  First, I am going to make a table that contains all of the names and colors for all of the game IDs.  Even though I only need those for Dallas, building a shiny app for this would mean that I could select by teams above and make it extensible.  At the end, I will only need those for Dallas so I will separate them off.

```{r}
all_2018_games %>%  select(home_team, home_score,  away_team, away_score) %>% head()
```

Cool.

```{r}
ntable <- all_2018_games %>% select(game_id, home_team, away_team)
ntableH <- ntable
ntableH <- ntableH %>% left_join(nflteams, by = c("home_team" = "abbr"))
names(ntableH) <- paste0("Home_",names(ntableH), sep="")
ntableH <- ntableH %>% rename(., game_id = Home_game_id, home_team = Home_home_team, away_team = Home_away_team)
ntableA <- ntable
ntableA <- ntableA %>% left_join(nflteams, by = c("away_team" = "abbr"))
names(ntableA) <- paste0("Away_",names(ntableA), sep="")
ntableA <- ntableA %>% rename(., game_id = Away_game_id, home_team = Away_home_team, away_team = Away_away_team)
My.NFL.Table <- ntableH %>% inner_join(ntableA)
My.NFL.Table <- My.NFL.Table %>% left_join(all_2018_games)
Dallas.Table <- My.NFL.Table %>% filter(home_team=="DAL" | away_team=="DAL")
Dallas.Table %>% head()
```

One nice little bit of data recovery here, the season schedule.

```{r}
Dallas.Table %>% select(game_id,Home_team,home_score, Away_team, away_score)
```

Now I want to put together a plot of the season.  This is pretty cool but it still needs a little bit of work.  The magic is that Dallas is a constant color.

```{r}
dal_wp <- dal_season %>% 
  filter(!is.na(home_wp),
         !is.na(away_wp)) %>% unite(GIDGSR, game_seconds_remaining, game_id, sep=":")
dal_wp <- dal_wp %>% dplyr::select(GIDGSR,
                home_wp,
                away_wp)  %>%
  gather(team, wpa, -GIDGSR) %>% separate(., GIDGSR, c("GSR", "game_id"), sep=":") %>% 
  mutate(game_seconds_remaining = as.integer(GSR))
dal_plt <- dal_wp %>% left_join(My.NFL.Table)
dal_plt <- dal_plt %>% left_join(all_2018_games)
dal_plt$colors1 <- NA
dal_plt[dal_plt$team=="home_wp","colors1"] <- dal_plt[dal_plt$team=="home_wp","Home_primary"]
dal_plt[dal_plt$team=="away_wp","colors1"] <- dal_plt[dal_plt$team=="away_wp","Away_primary"]
dal_plt[dal_plt$team=="home_wp","team"] <- dal_plt[dal_plt$team=="home_wp","home_team"]
dal_plt[dal_plt$team=="away_wp","team"] <- dal_plt[dal_plt$team=="away_wp","away_team"]
dal_plt$dateG <- substring(dal_plt$game_id, 5, 8)
dal_plt$titleS <- with(dal_plt, paste0(dateG,": ",Home_team,"(",home_score,") v. ", Away_team ,"(",away_score,")"))
Mini.GSR <- dal_plt %>% group_by(game_id, team) %>% slice( n() ) %>% ungroup() %>% mutate(labs1 = team) %>%  select(game_id, team, game_seconds_remaining, labs1)
dal_plt <- dal_plt %>% left_join(Mini.GSR)
p <- dal_plt %>% ggplot() + aes(x = game_seconds_remaining, y = wpa, color = team, label = labs1) +
  geom_line(size = 1) +
  geom_label(size=6.5, nudge_x = 150, hjust=1.5) +
  geom_hline(yintercept = 0.5, color = "gray", linetype = "dashed") +
  scale_color_viridis_d(guide=FALSE) +
  scale_x_reverse(breaks = seq(0, 3600, 300)) + 
  geom_vline(xintercept = 900, linetype = "dashed", black) + 
  geom_vline(xintercept = 1800, linetype = "dashed", black) + 
  geom_vline(xintercept = 2700, linetype = "dashed", black) + 
  geom_vline(xintercept = 0, linetype = "dashed", black) + 
  labs(
    x = "Time Remaining (seconds)",
    y = "Win Probability",
    title="2018 Dallas Cowboys Season",
    subtitle = "{closest_state}",
    caption = "Data from nflscrapR"
  ) + theme_minimal() + theme(text=element_text(size=12)) + transition_states(titleS, transition_length=10, state_length = 15)
animate(p, nframes=450)
```


I can write a function to take an input and give an animation for a team.

```{r}
season_animator <- function(teamName, data1, data2) {
dal_season <- data1 %>% filter(home_team==teamName | away_team==teamName)
ntable <- data2 %>% select(game_id, home_team, away_team)
ntableH <- ntable
ntableH <- ntableH %>% left_join(nflteams, by = c("home_team" = "abbr"))
names(ntableH) <- paste0("Home_",names(ntableH), sep="")
ntableH <- ntableH %>% rename(., game_id = Home_game_id, home_team = Home_home_team, away_team = Home_away_team)
ntableA <- ntable
ntableA <- ntableA %>% left_join(nflteams, by = c("away_team" = "abbr"))
names(ntableA) <- paste0("Away_",names(ntableA), sep="")
ntableA <- ntableA %>% rename(., game_id = Away_game_id, home_team = Away_home_team, away_team = Away_away_team)
My.NFL.Table <- ntableH %>% inner_join(ntableA)
My.NFL.Table <- My.NFL.Table %>% left_join(all_2018_games)
Team.Table <- My.NFL.Table %>% filter(home_team==teamName | away_team==teamName)
Team.Table %>% head()
Team.Table %>% select(game_id,Home_team,home_score, Away_team, away_score)
dal_wp <- dal_season %>% 
  filter(!is.na(home_wp),
         !is.na(away_wp)) %>% unite(GIDGSR, game_seconds_remaining, game_id, sep=":")
dal_wp <- dal_wp %>% dplyr::select(GIDGSR,
                home_wp,
                away_wp)  %>%
  gather(team, wpa, -GIDGSR) %>% separate(., GIDGSR, c("GSR", "game_id"), sep=":") %>% 
  mutate(game_seconds_remaining = as.integer(GSR))
dal_plt <- dal_wp %>% left_join(My.NFL.Table)
dal_plt <- dal_plt %>% left_join(data2)
dal_plt$colors1 <- NA
dal_plt[dal_plt$team=="home_wp","colors1"] <- dal_plt[dal_plt$team=="home_wp","Home_primary"]
dal_plt[dal_plt$team=="away_wp","colors1"] <- dal_plt[dal_plt$team=="away_wp","Away_primary"]
dal_plt[dal_plt$team=="home_wp","team"] <- dal_plt[dal_plt$team=="home_wp","home_team"]
dal_plt[dal_plt$team=="away_wp","team"] <- dal_plt[dal_plt$team=="away_wp","away_team"]
dal_plt$dateG <- substring(dal_plt$game_id, 5, 8)
dal_plt$titleS <- with(dal_plt, paste0(dateG,": ",Home_team,"(",home_score,") v. ", Away_team ,"(",away_score,")"))
Mini.GSR <- dal_plt %>% group_by(game_id, team) %>% slice( n() ) %>% ungroup() %>% mutate(labs1 = team) %>%  select(game_id, team, game_seconds_remaining, labs1)
dal_plt <- dal_plt %>% left_join(Mini.GSR)
p <- dal_plt %>% ggplot() + aes(x = game_seconds_remaining, y = wpa, color = team, label = labs1) +
  geom_line(size = 1) +
  geom_label(size=6, nudge_x = 200, hjust=2) +
  geom_hline(yintercept = 0.5, color = "gray", linetype = "dashed") +
  scale_color_viridis_d(guide=FALSE) +
  scale_x_reverse(breaks = seq(0, 3600, 300)) + 
  geom_vline(xintercept = 900, linetype = "dashed", black) + 
  geom_vline(xintercept = 1800, linetype = "dashed", black) + 
  geom_vline(xintercept = 2700, linetype = "dashed", black) + 
  geom_vline(xintercept = 0, linetype = "dashed", black) + 
  labs(
    x = "Time Remaining (seconds)",
    y = "Win Probability",
    title="2018 Dallas Cowboys Season",
    subtitle = "{closest_state}",
    caption = "Data from nflscrapR"
  ) + theme_minimal() + theme(text=element_text(size=12)) + transition_states(titleS, transition_length=10, state_length = 15)
animate(p, nframes=450)
}
SFS <- season_animator("SF", full_season_2018, all_2018_games)
SFS
```