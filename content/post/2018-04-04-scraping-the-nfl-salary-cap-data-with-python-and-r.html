---
title: Scraping the NFL Salary Cap Data with Python and R
author: RWW
date: '2018-04-04'
slug: scraping-the-nfl-salary-cap-data-with-python-and-r
categories:
  - R
  - tidyverse
  - python
  - reticulate
tags:
  - tidyverse
  - R
  - python
  - reticulate
---



<div id="the-nfl-data" class="section level1">
<h1>The NFL Data</h1>
<p>[SporTrac](<a href="http://www.sportrac.com" class="uri">http://www.sportrac.com</a>] has a wonderful array of financial data on sports. A student going to work for the Seattle Seahawks wanted the NFL salary cap data and I also found data on the English Premier League there. Now I have a source to scrape the data from.</p>
<p>With a source in hand, the key tool is the <em>SelectorGadget</em>. <em>SelectorGadget</em> is a browser add-in for Chrome that allows us to select text and identify the css or xpath selector to scrape the data. With that, it becomes easy to identify what we need. I navgiated to the website in base_url and found the team names had links to the cap data. I will use those links first. Let’s build that.</p>
<pre class="r"><code>library(rvest)
base_url &lt;- &quot;http://www.spotrac.com/nfl/&quot;
read.base &lt;- read_html(base_url)
team.URL &lt;- read.base %&gt;% html_nodes(&quot;.team-name&quot;) %&gt;% html_attr(&#39;href&#39;)
team.URL</code></pre>
<pre><code>##  [1] &quot;http://www.spotrac.com/nfl/arizona-cardinals/cap/&quot;   
##  [2] &quot;http://www.spotrac.com/nfl/atlanta-falcons/cap/&quot;     
##  [3] &quot;http://www.spotrac.com/nfl/baltimore-ravens/cap/&quot;    
##  [4] &quot;http://www.spotrac.com/nfl/buffalo-bills/cap/&quot;       
##  [5] &quot;http://www.spotrac.com/nfl/carolina-panthers/cap/&quot;   
##  [6] &quot;http://www.spotrac.com/nfl/chicago-bears/cap/&quot;       
##  [7] &quot;http://www.spotrac.com/nfl/cincinnati-bengals/cap/&quot;  
##  [8] &quot;http://www.spotrac.com/nfl/cleveland-browns/cap/&quot;    
##  [9] &quot;http://www.spotrac.com/nfl/dallas-cowboys/cap/&quot;      
## [10] &quot;http://www.spotrac.com/nfl/denver-broncos/cap/&quot;      
## [11] &quot;http://www.spotrac.com/nfl/detroit-lions/cap/&quot;       
## [12] &quot;http://www.spotrac.com/nfl/green-bay-packers/cap/&quot;   
## [13] &quot;http://www.spotrac.com/nfl/houston-texans/cap/&quot;      
## [14] &quot;http://www.spotrac.com/nfl/indianapolis-colts/cap/&quot;  
## [15] &quot;http://www.spotrac.com/nfl/jacksonville-jaguars/cap/&quot;
## [16] &quot;http://www.spotrac.com/nfl/kansas-city-chiefs/cap/&quot;  
## [17] &quot;http://www.spotrac.com/nfl/los-angeles-chargers/cap/&quot;
## [18] &quot;http://www.spotrac.com/nfl/los-angeles-rams/cap/&quot;    
## [19] &quot;http://www.spotrac.com/nfl/miami-dolphins/cap/&quot;      
## [20] &quot;http://www.spotrac.com/nfl/minnesota-vikings/cap/&quot;   
## [21] &quot;http://www.spotrac.com/nfl/new-england-patriots/cap/&quot;
## [22] &quot;http://www.spotrac.com/nfl/new-orleans-saints/cap/&quot;  
## [23] &quot;http://www.spotrac.com/nfl/new-york-giants/cap/&quot;     
## [24] &quot;http://www.spotrac.com/nfl/new-york-jets/cap/&quot;       
## [25] &quot;http://www.spotrac.com/nfl/oakland-raiders/cap/&quot;     
## [26] &quot;http://www.spotrac.com/nfl/philadelphia-eagles/cap/&quot; 
## [27] &quot;http://www.spotrac.com/nfl/pittsburgh-steelers/cap/&quot; 
## [28] &quot;http://www.spotrac.com/nfl/san-francisco-49ers/cap/&quot; 
## [29] &quot;http://www.spotrac.com/nfl/seattle-seahawks/cap/&quot;    
## [30] &quot;http://www.spotrac.com/nfl/tampa-bay-buccaneers/cap/&quot;
## [31] &quot;http://www.spotrac.com/nfl/tennessee-titans/cap/&quot;    
## [32] &quot;http://www.spotrac.com/nfl/washington-redskins/cap/&quot;</code></pre>
<pre class="r"><code># Clean up the URLs to get the team names by themselves.
team.names &lt;- gsub(&quot;/cap/&quot;,&quot;&quot;, gsub(base_url, &quot;&quot;, team.URL))</code></pre>
<p>With 32 team links to scrape, I can now scrape them.</p>
<div id="grabbing-team-tables" class="section level2">
<h2>Grabbing Team Tables</h2>
<p>Now I need to explore those links. When I started this, I wanted to learn some Python along the way. I found the following Python code that worked for the task. For completeness, I leave it here.</p>
<pre class="python"><code>import pandas as pd
import bs4
import re
import urllib2
#import requests
from urllib import urlopen
from bs4 import BeautifulSoup
base_url = &quot;http://www.spotrac.com/nfl/&quot;
def get_page(url):
    page = urlopen(base_url)
    soup = BeautifulSoup(page, &#39;lxml&#39;)
    file = open(&quot;spotrac_urls.txt&quot;, &#39;w&#39;)
    file.write(str(soup))
    file.close()
def get_team_table(url):
    page = urlopen(url)
    soup = BeautifulSoup(page, &#39;lxml&#39;)
get_page(base_url)
with open(&quot;spotrac_urls.txt&quot;, &#39;r&#39;) as file:
    for line in file:
        line = line.strip()
from bs4 import BeautifulSoup
page = open(&quot;spotrac_urls.txt&quot;, &#39;r&#39;)
soup = BeautifulSoup(page, &quot;lxml&quot;)
div = soup.find(&quot;div&quot;,&quot;subnav-posts&quot;)
links = div.find_all(&#39;a&#39;)
for link in links:
    print(link.get(&#39;href&#39;))
len(links)
def get_team_table(url):
    page = urlopen(url)
    soup = BeautifulSoup(page, &#39;lxml&#39;)
    data_rows = [row for row in soup.find(&quot;table&quot;, &quot;datatable&quot;).find_all(&quot;tr&quot;)]
    return data_rows
# create an empty list
team_data = []
for link in links:
    team_data.append(get_team_table(link.get(&#39;href&#39;)))
len(team_data)
#data_rows = [row for row in soup.find(&quot;td&quot;, &quot;center&quot;).find_all(&quot;tr&quot;)]
table_data = []
#soup = BeautifulSoup(team_data[0], &#39;lxml&#39;)
#This needs to be a nested for loop because inner items of the list are BeautifulSoup Elements
for row in team_data:
    for element in row:
        #print(type(element))
        if soup.find_all(&quot;td&quot;, attrs={&quot;class&quot;:&quot; right xs-hide &quot;}) is not None:
            table_data.append(element.get_text())
player_data = []
for row in table_data:
    player_data.append(row.split(&quot;\n&quot;))
    #print(player_data)
len(player_data)
import pandas as pd
df = pd.DataFrame(player_data)
df = df.drop(14, 1)
df = df.drop(0, 1)
df = df.drop(1, 1)
df = df.drop(df.index[[0]])
#df.set_index(1, inplace=True)
print(df.shape)
df.head()
players = []
for row in team_data[0]:
    if row.get_text(&quot;tr&quot;) is not None:
        players.append(row) 
column_headers = [col.get_text() for col in players[0].find_all(&quot;th&quot;) if col.get_text()]
len(column_headers)
df.columns = column_headers
df.head()
#The header repeated itself in the data.  This didn&#39;t reveal itself until the data type conversion step below
#but this fixes all occurrences of it.
rows_to_be_dropped = df.loc[df[&#39;Cap Hit&#39;] == &#39;Cap %&#39;].index
rows_to_be_kept = df.loc[df[&#39;Cap Hit&#39;] != &#39;Cap %&#39;].index
df = df.drop(rows_to_be_dropped)
df2 = pd.Series(data=rows_to_be_dropped)
#Apply a regex to convert the &#39;Cap Hit&#39; column from a string to a float.  
# df[&#39;Cap Hit&#39;] =(df[&#39;Cap Hit&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace( &#39;[(]&#39;,&#39;-&#39;,   regex=True ).astype(float))
# My fix
df[&#39;Cap.Hit&#39;] = (df[&#39;Cap Hit&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).replace(&#39;\s\s.*&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Base.Salary&#39;] = (df[&#39;Base Salary&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Signing.Bonus&#39;] = (df[&#39;Signing Bonus&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Roster.Bonus&#39;] = (df[&#39;Roster Bonus&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Option.Bonus&#39;] = (df[&#39;Option Bonus&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Workout.Bonus&#39;] = (df[&#39;Workout Bonus&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Restruc.Bonus&#39;] = (df[&#39;Restruc. Bonus&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Misc&#39;] = (df[&#39;Misc.&#39;].replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
df[&#39;Dead.Cap&#39;] = (df[&#39;Dead Cap&#39;].replace(&#39;\(&#39;,&quot;&quot;,regex=True).replace(&#39;\)&#39;,&quot;&quot;,regex=True).replace(&#39;[\$,)]&#39;, &quot;&quot;, regex=True).replace(&#39;[-,)]&#39;, &quot;&quot;, regex=True).astype(float))
#Sanity check to make sure it worked.
df[&#39;Cap Hit&#39;].sum()</code></pre>
<p>There are a few wonderful things about Beautiful Soup. But it is still faster and easier for me to do things in R. Here is some R code for the same task. The R table is a messy data structure but is easier to get.</p>
<pre class="r"><code>library(stringr)
data.creator &lt;- function(link) {
read_html(link) %&gt;% html_nodes(&quot;table&quot;) %&gt;% html_table(header=TRUE, fill=TRUE) -&gt; res
names(res) &lt;- c(&quot;Active&quot;,&quot;Draft&quot;,&quot;Inactive&quot;,&quot;Team1&quot;,&quot;Team2&quot;)
return(res)
  }
team.names &lt;- gsub(&quot;-&quot;, &quot; &quot;, team.names)
simpleCap &lt;- function(x) {
  s &lt;- strsplit(x, &quot; &quot;)[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep=&quot;&quot;, collapse=&quot; &quot;)
}
team.names &lt;- sapply(team.names, simpleCap)
NFL.scrape &lt;- sapply(team.URL, function(x) {data.creator(x)})
names(NFL.scrape) &lt;- team.names 
# This is a hack but it works
Actives &lt;- lapply(NFL.scrape, function(x){x$Active})
rep.res &lt;- sapply(seq(1,32), function(x) {dim(Actives[[x]])[[1]]})
clean.me.2 &lt;- function(data) {
data %&gt;% str_remove_all(&quot;[\\t]&quot;) %&gt;% str_split(&quot;\\n\\n\\n&quot;) %&gt;% unlist() %&gt;% matrix(data=., ncol=2, byrow=TRUE) -&gt; dat
return(dat)
}
clean.me &lt;- function(data) {
str_remove_all(data, &quot;[\\t]&quot;)
}
clean.me.num &lt;- function(data) {
str_remove_all(data, &quot;[\\$,()\\-]&quot;)
  }
Players &lt;- lapply(Actives, function(x){ clean.me.2(x[,1])})
Last.Name &lt;- unlist(lapply(Players, function(x) {x[,1]}))
Player.Name &lt;- unlist(lapply(Players, function(x) {x[,2]}))
Team &lt;- rep(names(Actives),rep.res)
Position &lt;- unlist(lapply(Actives, function(x){ clean.me(x[,2])}))
Base.Salary &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Base Salary&#39;])}))
Base.Salary &lt;- as.numeric(Base.Salary)
Signing.Bonus &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Signing Bonus&#39;])}))
Signing.Bonus &lt;- as.numeric(Signing.Bonus)
Roster.Bonus &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Roster Bonus&#39;])}))
Roster.Bonus &lt;- as.numeric(Roster.Bonus)
Option.Bonus &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Option Bonus&#39;])}))
Option.Bonus &lt;- as.numeric(Option.Bonus)
Workout.Bonus &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Workout Bonus&#39;])}))
Workout.Bonus &lt;- as.numeric(Workout.Bonus)
Cap.Pct &lt;- unlist(lapply(Actives, function(x){ x[,&#39;Cap %&#39;]}))
Restruc.Bonus &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Restruc. Bonus&#39;])}))
Restruc.Bonus &lt;- as.numeric(Restruc.Bonus)
Dead.Cap &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Dead Cap&#39;])}))
Dead.Cap &lt;- as.numeric(Dead.Cap)
Misc.Cap &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Misc.&#39;])}))
Misc.Cap &lt;- as.numeric(Misc.Cap)
Cap.Hit &lt;- unlist(lapply(Actives, function(x){ clean.me.num(x[,&#39;Cap Hit&#39;])}))
Cap.Hit &lt;- str_replace_all(Cap.Hit, pattern=&quot;\\s\\s*&quot;, &quot;&quot;)
NFL.Salary.Data &lt;- data.frame(Player=Player.Name, 
                       Last.Name = Last.Name,
                       Team=Team, 
                       Position=Position, 
                       Base.Salary=Base.Salary,
                       Signing.Bonus=Signing.Bonus,
                       Roster.Bonus=Roster.Bonus,
                       Option.Bonus=Option.Bonus,
                       Workout.Bonus=Workout.Bonus,
                       Cap.Hit=Cap.Hit,
                       Restruc.Bonus=Restruc.Bonus,
                       Dead.Cap=Dead.Cap,
                       Misc.Cap=Misc.Cap,
                       Cap.Pct=Cap.Pct)</code></pre>
<pre class="r"><code>library(tidyverse)
library(skimr)
skim(NFL.Salary.Data)</code></pre>
<pre><code>## Skim summary statistics
##  n obs: 2240 
##  n variables: 14 
## 
## Variable type: factor 
##   variable missing complete    n n_unique
##    Cap.Hit       0     2240 2240     1043
##  Last.Name       0     2240 2240     1489
##     Player       0     2240 2240     2227
##   Position       0     2240 2240       22
##       Team       0     2240 2240       32
##                             top_counts ordered
##  480: 280, 555: 230, 630: 185, 705: 66   FALSE
##     Jon: 41, Wil: 39, Smi: 31, Joh: 30   FALSE
##         Aus: 2, Bra: 2, Bra: 2, Chr: 2   FALSE
##    WR: 289, CB: 242, DE: 179, OLB: 171   FALSE
##     New: 86, Ind: 78, New: 78, Cle: 77   FALSE
## 
## Variable type: numeric 
##       variable missing complete    n       mean         sd p0       p25
##    Base.Salary       0     2240 2240 1701833.12 2559557.77  0 555000   
##        Cap.Pct       0     2240 2240       1.36       2.05  0      0.31
##       Dead.Cap       0     2240 2240 2236275.57 5645218.44  0      0   
##       Misc.Cap       0     2240 2240    9145.09   81164.72  0      0   
##   Option.Bonus       0     2240 2240   13266.37  168013.48  0      0   
##  Restruc.Bonus       0     2240 2240   44895.26  341612.2   0      0   
##   Roster.Bonus       0     2240 2240  206874.24   1e+06     0      0   
##  Signing.Bonus       0     2240 2240  449240.18  960866.84  0      0   
##  Workout.Bonus       0     2240 2240   20157.59   76573.49  0      0   
##       p50        p75          p100     hist
##  7e+05    1500000          2.2e+07 ▇▁▁▁▁▁▁▁
##      0.41       1.42      18.02    ▇▁▁▁▁▁▁▁
##  50178    1329366.25       8.2e+07 ▇▁▁▁▁▁▁▁
##      0          0    2085000       ▇▁▁▁▁▁▁▁
##      0          0    4750000       ▇▁▁▁▁▁▁▁
##      0          0    5561666       ▇▁▁▁▁▁▁▁
##      0          0          2.9e+07 ▇▁▁▁▁▁▁▁
##   3333      4e+05      1e+07       ▇▁▁▁▁▁▁▁
##      0          0    1335000       ▇▁▁▁▁▁▁▁</code></pre>
<pre class="r"><code>NFL.Salary.Data %&gt;% group_by(Team) %&gt;% summarise(Total.Base.Salary=sum(Base.Salary))</code></pre>
<pre><code>## # A tibble: 32 x 2
##    Team               Total.Base.Salary
##    &lt;fct&gt;                          &lt;dbl&gt;
##  1 Arizona Cardinals         105629569.
##  2 Atlanta Falcons           132847353.
##  3 Baltimore Ravens          111906351.
##  4 Buffalo Bills              94577460.
##  5 Carolina Panthers         110158355.
##  6 Chicago Bears              85128180.
##  7 Cincinnati Bengals        134855807.
##  8 Cleveland Browns          122139767.
##  9 Dallas Cowboys            128347113.
## 10 Denver Broncos            140672444.
## # ... with 22 more rows</code></pre>
<pre class="r"><code>NFL.Salary.Data %&gt;% group_by(Position) %&gt;% skim(Base.Salary)</code></pre>
<pre><code>## Skim summary statistics
##  n obs: 2240 
##  n variables: 14 
##  group variables: Position 
## 
## Variable type: numeric 
##  Position    variable missing complete   n       mean         sd     p0
##         C Base.Salary       0       62  62   2e+06    2173761.05      0
##        CB Base.Salary       0      242 242 1594781.37 2433196.22      0
##        DE Base.Salary       0      179 179   2e+06    3065728.54      0
##        DT Base.Salary       0      144 144   2e+06    3120185.84      0
##        FB Base.Salary       0       26  26  815000     560564         0
##        FS Base.Salary       0       57  57 2641985.07 2783070.36      0
##         G Base.Salary       0      136 136 1704599.21 2115607.14      0
##       ILB Base.Salary       0      120 120 1378939.22 1901654.33      0
##         K Base.Salary       0       38  38 1383498.11  946083.47 480000
##        LB Base.Salary       0        1   1  616500         NA    616500
##        LS Base.Salary       0       34  34  761617.65   2e+05    480000
##        LT Base.Salary       0       38  38 4587732.76 4142986.8       0
##       OLB Base.Salary       0      171 171 1938283.55 2869077.82      0
##         P Base.Salary       0       37  37 1242027.03   8e+05    480000
##        QB Base.Salary       0       96  96 3408382.24 5078200.92      0
##        RB Base.Salary       0      151 151 1088425.34 1459116.95      0
##        RT Base.Salary       0       52  52 2314986.23   2e+06         0
##         S Base.Salary       0       68  68  576320.49  123126.23      0
##        SS Base.Salary       0       53  53 1566535.64 1521405.49      0
##         T Base.Salary       0       94  94  587082.02  222252.32 480000
##        TE Base.Salary       0      152 152 1301806.18 1570488.64 480000
##        WR Base.Salary       0      289 289 1624579.17 2486576.11      0
##        p25       p50       p75          p100     hist
##  630000     862290.5 2693750     9e+06       ▇▁▂▁▁▁▁▁
##  555000     630000   1329725         1.4e+07 ▇▁▁▁▁▁▁▁
##  555000     790000   1812276         1.7e+07 ▇▁▁▁▁▁▁▁
##  555000     630000   1687089.5       1.7e+07 ▇▁▁▁▁▁▁▁
##  555000     667500    837500   2750000       ▂▇▆▁▂▁▁▁
##  762911    1426150   3250000         1.1e+07 ▇▃▁▁▁▁▁▁
##  555000     790000   1880750     1e+07       ▇▂▁▁▁▁▁▁
##  555000      7e+05     1e+06     1e+07       ▇▁▁▁▁▁▁▁
##  555000      9e+05     2e+06   3400000       ▇▁▁▁▂▁▁▁
##  616500     616500    616500    616500       ▁▁▁▇▁▁▁▁
##  573750     790000    915000   1100000       ▇▃▂▃▂▅▆▁
##  961056.25 2310342   8825000         1.2e+07 ▇▂▁▂▁▂▂▂
##  555000      7e+05   1639242         1.5e+07 ▇▁▁▁▁▁▁▁
##  555000      1e+06   1500000     3e+06       ▇▂▃▁▁▂▁▂
##  592500     831832   3242341         2.2e+07 ▇▁▁▁▁▁▁▁
##  555000     630000     1e+06         1.5e+07 ▇▁▁▁▁▁▁▁
##  768750    1897621   3918750   9341000       ▇▅▂▃▁▁▁▁
##  480000     555000    630000     1e+06       ▁▁▁▃▇▁▁▁
##  630000     875000   1750000   6800000       ▇▃▁▁▁▁▁▁
##  480000     555000    630000   2312212       ▇▁▁▁▁▁▁▁
##  555000     630000     1e+06   8250000       ▇▁▁▁▁▁▁▁
##  555000     630000   1200000         1.6e+07 ▇▁▁▁▁▁▁▁</code></pre>
<p>Now I have my salary data.</p>
</div>
</div>
